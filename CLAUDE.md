# TagExplorer - Instructions Claude

## Project Overview
Système de fichiers basé sur des tags avec visualisation en graphe. POC open source.

## Tech Stack
- **Frontend**: React 18 + TypeScript + Vite
- **Backend**: Convex (DB + File Storage + Functions)
- **IA**: Vercel AI Gateway → `google/gemini-2.5-flash-lite` (vision)
- **Graph**: react-force-graph-2d
- **Styling**: Tailwind CSS

## Coding Conventions
- Noms de fichiers et variables en lowerCamelCase
- Composants React en PascalCase
- Pas de commentaires superflus, code auto-documenté
- TypeScript strict, pas de `any`

## Project Structure
```
/src
  /components
    uploadSidebar.tsx      # Zone upload + suggestions tags
    graphView.tsx          # Graphe principal
    filePreview.tsx        # Modal preview
    tagChip.tsx            # Composant tag réutilisable
  /hooks
    useFileAnalysis.ts     # Hook analyse IA
  app.tsx
  main.tsx

/convex
  schema.ts                # Tables: files, tags, fileTags
  files.ts                 # Mutations/queries fichiers
  tags.ts                  # Mutations/queries tags
  analyze.ts               # Action appel IA
  http.ts                  # HTTP router (si besoin)
```

## Key Dependencies Documentation

### Convex
- **Docs**: https://docs.convex.dev/
- **React Quickstart**: https://docs.convex.dev/quickstart/react
- **File Storage**: https://docs.convex.dev/file-storage/upload-files

#### Upload Pattern (3 steps)
```typescript
// 1. convex/files.ts - Generate upload URL
export const generateUploadUrl = mutation({
  args: {},
  handler: async (ctx) => {
    return await ctx.storage.generateUploadUrl();
  },
});

// 2. Client - POST file to URL
const postUrl = await generateUploadUrl();
const result = await fetch(postUrl, {
  method: "POST",
  headers: { "Content-Type": file.type },
  body: file,
});
const { storageId } = await result.json();

// 3. convex/files.ts - Save to DB
export const saveFile = mutation({
  args: { storageId: v.id("_storage"), name: v.string(), type: v.string() },
  handler: async (ctx, args) => {
    return await ctx.db.insert("files", {
      storageId: args.storageId,
      name: args.name,
      type: args.type,
      createdAt: Date.now(),
    });
  },
});
```

#### Serving Files
```typescript
// Get URL from storage ID
const url = await ctx.storage.getUrl(storageId);
```

### Vercel AI Gateway
- **Docs**: https://vercel.com/docs/ai-gateway
- **Getting Started**: https://vercel.com/docs/ai-gateway/getting-started
- **Models**: https://vercel.com/docs/ai-gateway/models-and-providers
- **Modèle utilisé**: `google/gemini-2.5-flash-lite` (vision support, économique)

#### Avec AI SDK (recommandé)
```typescript
import { generateText } from 'ai';

const result = await generateText({
  model: 'google/gemini-2.5-flash-lite',
  messages: [{
    role: 'user',
    content: [
      { type: 'text', text: 'Analyze this image and suggest relevant tags...' },
      { type: 'image', image: base64Image }  // ou URL
    ]
  }],
  maxTokens: 500
});
```

#### Avec OpenAI SDK (compatible)
```typescript
import OpenAI from 'openai';

const client = new OpenAI({
  apiKey: process.env.AI_GATEWAY_API_KEY,
  baseURL: 'https://ai-gateway.vercel.sh/v1',
});

const response = await client.chat.completions.create({
  model: 'google/gemini-2.5-flash-lite',
  messages: [{
    role: 'user',
    content: [
      { type: 'text', text: 'Analyze this image and suggest relevant tags...' },
      { type: 'image_url', image_url: { url: 'data:image/jpeg;base64,...' } }
    ]
  }],
  max_tokens: 500
});
```

### react-force-graph-2d
- **NPM**: https://www.npmjs.com/package/react-force-graph-2d
- **GitHub**: https://github.com/vasturiano/react-force-graph
- **Examples**: https://vasturiano.github.io/react-force-graph/

#### Basic Usage
```tsx
import ForceGraph2D from 'react-force-graph-2d';

const graphData = {
  nodes: [
    { id: 'file1', name: 'photo.jpg', type: 'file' },
    { id: 'tag1', name: 'nature', type: 'tag' }
  ],
  links: [
    { source: 'file1', target: 'tag1' }
  ]
};

<ForceGraph2D
  graphData={graphData}
  nodeLabel={node => node.name}
  nodeColor={node => node.type === 'file' ? '#3b82f6' : '#10b981'}
  onNodeClick={node => console.log(node)}
/>
```

## Environment Variables
```env
# .env.local
CONVEX_DEPLOYMENT=...           # Auto-generated by Convex
AI_GATEWAY_API_KEY=...          # Vercel AI Gateway API key
```

Note: AI Gateway key must be set in Convex dashboard as environment variable for actions.
Get your key at: https://vercel.com/dashboard/ai-gateway/api-keys

## Commands
```bash
npm run dev          # Start Vite dev server
npx convex dev       # Start Convex dev (run in separate terminal)
```

## POC Constraints
- No authentication (single user)
- No automated tests
- Minimal error handling
- Desktop-first responsive
- Max ~100 nodes in graph for performance

## Convex Best Practices

### Core Principles
- **TypeScript-first**: Database code uses pure TypeScript with full type safety
- **Minimal boilerplate**: Less code, fewer errors
- **Automatic reactivity**: Data dependencies tracked without manual subscriptions
- **Transactional safety**: Read-only queries and transactional mutations prevent data corruption

### Patterns
- Use `query` for read-only operations (automatically cached and reactive)
- Use `mutation` for write operations (transactional, atomic)
- Use `action` for external API calls (like AI Gateway) - cannot directly modify DB
- Use `internalMutation` / `internalQuery` for server-side only operations

### Rules
- Never read entire documentation at once - use targeted searches
- Generate type-safe, validated, production-ready code
- Follow established Convex patterns

### Resources
- Convex docs: https://docs.convex.dev/
- AI code generation guide: https://docs.convex.dev/ai
- Convex rules reference: https://convex.link/convex_rules.txt
